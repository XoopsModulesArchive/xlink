<?php//  -------------------------------------------------------------------------- ////  [CONTENT RELATIONS MGR FOR XOOPS-R2]//  Author: Toms Veilands [tomsys@tomsys.net] [www.tomsys.net] [AKA tomsys]//  Credits: Xoops Team [www.xoops.org]//  Version: 1.0//  ReleaseDate: May 03, 2003//  License: GPL - [http://www.gnu.org/licenses/gpl.html]//  -------------------------------------------------------------------------- //include '../../../include/cp_header.php';if ( !is_object($xoopsUser) || !is_object($xoopsModule) || !$xoopsUser->isAdmin($xoopsModule->getVar('mid')) ) {	exit(_NOPERM);} else {		if ( isset($HTTP_POST_VARS) ) {		foreach ( $HTTP_POST_VARS as $k => $v ) {			${$k} = $v;	  	}	}		$modselect = isset($HTTP_GET_VARS['modselect']) ? intval($HTTP_GET_VARS['modselect']) : 0;		$limit = isset($HTTP_GET_VARS['limit'])     ? intval($HTTP_GET_VARS['limit'])     : 0;		$start = isset($HTTP_GET_VARS['start'])     ? intval($HTTP_GET_VARS['start'])     : 0;	   $hidden = isset($HTTP_GET_VARS['hidden'])    ? intval($HTTP_GET_VARS['hidden'])    : 0;    $searchstr = isset($HTTP_GET_VARS['searchstr']) ?   trim($HTTP_GET_VARS['searchstr']) : '';		   $op = isset($HTTP_GET_VARS['op'])        ?   trim($HTTP_GET_VARS['op'])        : 'list';	   	$modselect = isset($HTTP_POST_VARS['modselect']) ? intval($HTTP_POST_VARS['modselect']) : $modselect;		$limit = isset($HTTP_POST_VARS['limit'])     ? intval($HTTP_POST_VARS['limit'])     : $limit;		$start = isset($HTTP_POST_VARS['start'])     ? intval($HTTP_POST_VARS['start'])     : $start;	   $hidden = isset($HTTP_POST_VARS['hidden'])    ? intval($HTTP_POST_VARS['hidden'])    : $hidden;    $searchstr = isset($HTTP_POST_VARS['searchstr']) ?   trim($HTTP_POST_VARS['searchstr']) : $searchstr;	   		   $op = isset($HTTP_POST_VARS['op'])        ?   trim($HTTP_POST_VARS['op'])        : $op;	   	switch ($op) {		case 'quickupdate':			$count = $rows;					for ( $r = 0; $r < $count; $r++ ) {												if ( $link_old_title[$r] != $link_title[$r]) {					 $sql = "UPDATE ".$xoopsDB->prefix('xlink_uri')." SET title='".$link_title[$r]."' WHERE urid='".$link_id[$r]."'";					 $res = $xoopsDB->query($sql); //sorry no testing here yet				}        if ( $link_old_title[$r] != $link_title[$r]) {					 $sql = "UPDATE ".$xoopsDB->prefix('xlink_tmpuri')." SET title='".$link_title[$r]."' WHERE recid='".$link_id[$r]."'";					 $res = $xoopsDB->query($sql); //sorry no testing here yet           }				if ( $link_old_visible[$r] != $link_visible[$r]) {					 $sql = "UPDATE ".$xoopsDB->prefix('xlink')." SET visible='".$link_visible[$r]."' WHERE urid='".$link_id[$r]."'";					 $res = $xoopsDB->query($sql); //sorry no testing here yet				}			}			redirect_header($HTTP_REFERER, 1, _MA_XLINK_DBSUCCESS);		break;		case 'delconfirm':			xoops_cp_header();			$confirm_values = array('rec_id'    => $rec_id,									'modselect' => $modselect,									'hidden'    => $hidden,									'limit'     => $limit,									'start'     => $start,									'searchstr' => $searchstr,									'op'		=> 'delete');												xoops_confirm($confirm_values,'index.php', _MA_XLINK_RUSURE."<br /><br />".$linktitle."", _MA_XLINK_CONFIRM);					break;		case 'delete':			$sql = "DELETE FROM ".$xoopsDB->prefix('xlink_tmpuri')." WHERE recid = ".intval($rec_id)."";			$success1 = $xoopsDB->query($sql) ? 1 : 0; 			$sql = "DELETE FROM ".$xoopsDB->prefix('xlink')." WHERE urid = ".intval($rec_id)."";			$success = $xoopsDB->query($sql) ? 1 : 0;			$sql = "DELETE FROM ".$xoopsDB->prefix('xlink_uri')." WHERE urid = ".intval($rec_id)."";					if($xoopsDB->query($sql) && $success && $success1){				$fintxt = _MA_XLINK_DBSUCCESS;			} else {				$fintxt = _MA_XLINK_DBFAILURE;			}			redirect_header('index.php?modselect='.$modselect.'&amp;hidden='.$hidden.'&amp;limit='.$limit.'&amp;start='.$start,1,$fintxt);		break;		case 'bookmark':						echo $link_title[1];			   $link_id = !empty($link_id)    ? intval($link_id)          : 0;			  $moduleid = !empty($moduleid)   ? intval($moduleid)         : 0;			 $linktitle = !empty($linktitle)  ? trim($linktitle)  : "";			  $link_url = !empty($link_url)   ? trim($link_url)   : "";			$sql = "INSERT INTO ".$xoopsDB->prefix("xlink_tmpuri")." VALUES (NULL, $moduleid, '$link_url', $link_id, '$linktitle') ";			if ($xoopsDB->queryF($sql)) {				redirect_header($HTTP_REFERER, 1, _MA_XLINK_DBSUCCESS);			} else {				redirect_header($HTTP_REFERER, 1, _MA_XLINK_DBFAILURE);			}		break;		case 'list':			xoops_cp_header();			echo "<h4 style='border-bottom:2px red solid;padding:3px;'>"._MA_XLINK_MODULETITLE."</h4>";			make_link_list();		break;				default:			echo $op;			redirect_header($HTTP_REFERER, 1, _MA_XLINK_OPNONEXIST);		break;	}	xoops_cp_footer();}function make_link_list(){		global $xoopsDB, $xoopsConfig, $searchstr, $modselect, $start, $limit, $hidden, $op, $rows;		$result = $xoopsDB->query('SELECT count(*) FROM '.$xoopsDB->prefix('xlink'));		$totalz  = $xoopsDB->fetchArray($result);		$total = $totalz['count(*)'];		echo _MA_XLINK_TOTAL." - (<strong>".$total."</strong>), ";				$limit_array = array(10, 30, 60, 100);		if (!in_array($limit, $limit_array)) {			$limit = 60;		}				$module_handler =& xoops_gethandler('module');		$installed_mods =& $module_handler->getObjects();		$modnames		= array();		$dropdown       = "<option".$sel." value=''>"._MA_XLINK_ALLMODULES."</option>";		foreach ($installed_mods as $module) {				if ($module->getVar('mid') == $modselect) {					$sel = ' selected="selected"';				}				$dropdown .= "<option".$sel." value='".$module->getVar('mid')."'>".$module->getVar('name')."</option>";		}		$limdrop = '';		foreach ($limit_array as $k) {			$sel = '';			if (isset($limit) && $k == $limit) {				$sel = ' selected="selected"';			}			$limdrop .= '<option value="'.$k.'"'.$sel.'>'.$k.'</option>';		}		$sql_hidden = "";		if(($hidden) == 0) {			$hidedrop = '<option value="0">'._MA_XLINK_SHOWALL.'</option>						       <option value="1">'._MA_XLINK_SHOWONLYHIDDEN.'</option>						       <option value="2">'._MA_XLINK_SHOWONLYVISIBLE.'</option>';		} elseif (($hidden) == 1) {			$hidedrop = '<option value="0">'._MA_XLINK_SHOWALL.'</option>						       <option selected="selected" value="1">'._MA_XLINK_SHOWONLYHIDDEN.'</option>						       <option value="2">'._MA_XLINK_SHOWONLYVISIBLE.'</option>';						$sql_hidden = 'visible = 1 ';		} elseif(($hidden) == 2) {			$hidedrop = '<option value="0">'._MA_XLINK_SHOWALL.'</option>						       <option selected="selected" value="1">'._MA_XLINK_SHOWONLYHIDDEN.'</option>						       <option selected="selected" value="2">'._MA_XLINK_SHOWONLYVISIBLE.'</option>';						$sql_hidden = 'visible != 1 ';		} 				$sql1  = "SELECT * FROM ".$xoopsDB->prefix('xlink')." a, ".$xoopsDB->prefix('xlink_uri')." b WHERE a.urid = b.urid "; 				$sql = !empty($modselect) ? "AND a.modid = ".$modselect : "";		$sql .= !empty($sql_hidden) ? " AND a.".$sql_hidden : "";		$sql .= !empty($searchstr) ? " AND b.title LIKE '%".$searchstr."%'" : "";				$sql .= !empty($order) ? " ORDER BY ".$order : " ORDER BY modid, title ";		$sql1 .= $sql." LIMIT ".$start." , ".$limit;				$sql2  = "SELECT count(*) FROM ".$xoopsDB->prefix('xlink')." a, ".$xoopsDB->prefix('xlink_uri')." b WHERE a.urid = b.urid ";		$sql2 .= $sql;			    $result = $xoopsDB->query($sql1);		 		  $rows = $xoopsDB->getRowsNum($result);		  		$result2 = $xoopsDB->query($sql2);		 	  $selected_recz = $xoopsDB->fetchArray($result2);	  $selected_recs = $selected_recz['count(*)'];	  	echo _MA_XLINK_SELECTEDBYCRITERIA." - (".$selected_recs.")";		  		  	     		 echo "<form action='index.php' method='get'>		 		<label>"._MA_XLINK_CRITERIA.": </label>				<select name='modselect' >".$dropdown."</select>								<select name='hidden'    >".$hidedrop."</select>				<select name='limit'     >".$limdrop."</select>				<label> <br>              "._MA_XLINK_TITLECONTAINS.": </label>				<input  type='text' name='searchstr' value='".stripslashes($searchstr)."' size='20' maxlength='20'>				<input  type='submit' value='"._MA_XLINK_GO."' >		 	   </form>		 	  ";		 		 		 if ($rows > 0) {                  echo "<form action='index.php' method='post'><table class='outer' border='0' cellpadding='0' cellspacing='1' width='100%'>"		     ."<th colspan='7' align='center'>"."&raquo;&nbsp;"._MA_XLINK_SELECTEDBYCRITERIA."&nbsp;&laquo;"."</th>"             ."<tr class='head'>			      <td align='center'>              "._MA_XLINK_ID.        "</td>				  <td align='center'>              "._MA_XLINK_MODULE.    "</td>				  <td width='85%'>                 "._MA_XLINK_TITLE.     "</td>				  <td align='center' width='1%'> "._MA_XLINK_HIDDEN.    "</td>				  <td colspan='3' align='center'>"._MA_XLINK_OPERATIONS."</td>			  </tr>";  		 $row = 0;		 		 while($data_item = $xoopsDB->fetchArray($result)) {		 $liner = $row % 2;		 			 	if ($liner == 0) { 				echo "<tr class='odd'>" ;			} else {				echo "<tr class='even'>" ;			}			if ($data_item['visible'] == 1) {				$vis_checked = "checked";			} else {				$vis_checked = "";			}			echo 			"		<td align='center'>					<input type='hidden' name='row' value='".$row."' />																<input type='hidden' name='link_id[$row]' value='".$data_item['urid']."' />".$data_item['urid']."					</td>					<td align='center'>          <input type='hidden' name='module_id[$row]' value='".$data_item['modid']."' />          ".$data_item['modid']."          </td>					<td align='left'>          <input type='hidden' name='link_old_title[$row]' value='".$data_item['title']."' />					<input type='text' name='link_title[$row]' value='".$data_item['title']."' size='60' maxlength='120' />					</td>					<td align='center'>          <input type='hidden' name='link_old_visible[$row]' value='".$data_item['visible']."' />					<input style='border:0px; background-color: transparent;' type='checkbox' name='link_visible[$row]' value='1' $vis_checked />          </td>					<td align='center'>          <a href='".$data_item['url']."' target='url_window'>          "._MA_XLINK_TARGETLINK."          </a>          </td>					<td align='center'>          <a href='".$data_item['home_url']."' target='home_window'>          "._MA_XLINK_HOMELINK."          </a>          </td>"					."<td align='center'>          <a href='./index.php?op=delconfirm"																		."&amp;rec_id="    .$data_item['urid']																		."&amp;linktitle=" .$data_item['title']																		."&amp;modselect=" .$modselect																		."&amp;hidden="    .$hidden																		."&amp;limit="     .$limit																		."&amp;start="     .$start																		."&amp;searchstr=" .$searchstr."'>          "._MA_XLINK_DELETELINK."          </a>          </td>			    </tr>";          			$row++;			        }        		echo "<tr class='foot'><td colspan='7' align='center'>					<input type='hidden' name='rows' 		  value='$row'>					<input type='hidden' name='modselect' value='".$modselect."'>					<input type='hidden' name='hidden'    value='".$hidden."'>					<input type='hidden' name='limit'     value='".$limit."'>					<input type='hidden' name='searchstr' value='".$searchstr."'>					<input type='hidden' name='op'   		  value='quickupdate'>					<input type='submit' name='update'		value='"._MA_XLINK_UPDATE."'>					<input type='reset'  name='reset'		  value='"._MA_XLINK_RESET."'>					</td>			    </tr>			    </table>          </form>";					if ($selected_recs > $limit) {			include_once XOOPS_ROOT_PATH.'/class/pagenav.php';			$nav = new XoopsPageNav($selected_recs, $limit, $start, 'start', 'op=list&amp;limit='.$limit.'&amp;sort='.$sort.'&amp;order='.$order.'&amp;modselect='.$modselect.'&amp;hidden='.$hidden);			echo _MA_XLINK_PAGES." ".$nav->renderNav()."";		}	}}?>